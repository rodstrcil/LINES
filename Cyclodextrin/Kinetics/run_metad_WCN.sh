i=1
while [ $i -le 100 ]
do
output_file=md_run_WCN${i}

cat >plumed.dat << EOF
FIT_TO_TEMPLATE reference=../conf_ref.pdb TYPE=OPTIMAL
WHOLEMOLECULES ENTITY0=1-147 ENTITY1=148-160

#define virtual sites
v2: FIXEDATOM AT=2.25,2.25,1.5
v3: FIXEDATOM AT=2.25,2.25,1.75
v4: FIXEDATOM AT=2.25,2.25,2.0
v5: FIXEDATOM AT=2.25,2.25,2.25
v6: FIXEDATOM AT=2.25,2.25,2.5
v7: FIXEDATOM AT=2.25,2.25,2.75
v8: FIXEDATOM AT=2.25,2.25,3.0
com0: COM ATOMS=1-147
com1: COM ATOMS=148-160
water: GROUP ATOMS=161-8932:3

#implement restraints
dist_rest: DISTANCE ATOMS=com1,com0 COMPONENTS
uwall: UPPER_WALLS ARG=dist_rest.z,dist_rest.y,dist_rest.x AT=1.5,0.4,0.4 KAPPA=500.0,500.0,500.0
lwall: LOWER_WALLS ARG=dist_rest.z,dist_rest.y,dist_rest.x AT=-1.5,-0.4,-0.4 KAPPA=500.0,500.0,500.0

#define molecular coordinates
CV0: DISTANCE ATOMS=com1,com0 COMPONENTS
CV1: COORDINATION GROUPA=v2 GROUPB=water SWITCH={RATIONAL D_0=0.0 R_0=0.35 NN=6 MM=10} NLIST NL_CUTOFF=1 NL_STRIDE=5
CV2: COORDINATION GROUPA=v3 GROUPB=water SWITCH={RATIONAL D_0=0.0 R_0=0.35 NN=6 MM=10} NLIST NL_CUTOFF=1 NL_STRIDE=5
CV3: COORDINATION GROUPA=v4 GROUPB=water SWITCH={RATIONAL D_0=0.0 R_0=0.35 NN=6 MM=10} NLIST NL_CUTOFF=1 NL_STRIDE=5
CV4: COORDINATION GROUPA=v5 GROUPB=water SWITCH={RATIONAL D_0=0.0 R_0=0.35 NN=6 MM=10} NLIST NL_CUTOFF=1 NL_STRIDE=5
CV5: COORDINATION GROUPA=v6 GROUPB=water SWITCH={RATIONAL D_0=0.0 R_0=0.35 NN=6 MM=10} NLIST NL_CUTOFF=1 NL_STRIDE=5
CV6: COORDINATION GROUPA=v7 GROUPB=water SWITCH={RATIONAL D_0=0.0 R_0=0.35 NN=6 MM=10} NLIST NL_CUTOFF=1 NL_STRIDE=5
CV7: COORDINATION GROUPA=v8 GROUPB=water SWITCH={RATIONAL D_0=0.0 R_0=0.35 NN=6 MM=10} NLIST NL_CUTOFF=1 NL_STRIDE=5
CV8: COORDINATION GROUPA=149 GROUPB=water SWITCH={RATIONAL D_0=0.0 R_0=0.35 NN=6 MM=10} NLIST NL_CUTOFF=1 NL_STRIDE=5
CV9: COORDINATION GROUPA=152 GROUPB=water SWITCH={RATIONAL D_0=0.0 R_0=0.35 NN=6 MM=10} NLIST NL_CUTOFF=1 NL_STRIDE=5
CV10: COORDINATION GROUPA=155 GROUPB=water SWITCH={RATIONAL D_0=0.0 R_0=0.35 NN=6 MM=10} NLIST NL_CUTOFF=1 NL_STRIDE=5
CV11: COORDINATION GROUPA=158 GROUPB=water SWITCH={RATIONAL D_0=0.0 R_0=0.35 NN=6 MM=10} NLIST NL_CUTOFF=1 NL_STRIDE=5

#define reaction coordinates
CUSTOM ...
LABEL=rc0
ARG=CV0.z,CV1,CV2,CV3,CV4,CV5,CV6,CV7,CV8,CV9,CV10,CV11
VAR=CV0.z,CV1,CV2,CV3,CV4,CV5,CV6,CV7,CV8,CV9,CV10,CV11
PERIODIC=NO
FUNC=0.0*CV0.z+0.031543186648424856*CV1+0.07638150076097547*CV2+-0.29332328873235086*CV3+-0.5653419776284099*CV4+-0.279528622485384*CV5+-0.07272156731760196*CV6+-0.04271387833032576*CV7+-0.34593100515708974*CV8+-0.462160814560195*CV9+-0.4030404648526199*CV10+-0.08105024762284371*CV11
... CUSTOM
CUSTOM ...
LABEL=rc1
ARG=CV0.z,CV1,CV2,CV3,CV4,CV5,CV6,CV7,CV8,CV9,CV10,CV11
VAR=CV0.z,CV1,CV2,CV3,CV4,CV5,CV6,CV7,CV8,CV9,CV10,CV11
PERIODIC=NO
FUNC=1.0*CV0.z+0.0*CV1+0.0*CV2+0.0*CV3+0.0*CV4+0.0*CV5+0.0*CV6+0.0*CV7+0.0*CV8+0.0*CV9+0.0*CV10+0.0*CV11
... CUSTOM

#define biasing potential
metad: METAD ...
        ARG=rc0,rc1 SIGMA=0.25,0.05 HEIGHT=0.3 PACE=10000 GRID_MIN=-30,-1 GRID_MAX=-5,1 GRID_BIN=100,100
        GRID_WFILE=grid.dat GRID_WSTRIDE=10000 CALC_RCT
...

#print out results
PRINT ARG=CV0.z,metad.* FILE=${output_file}.txt STRIDE=25
EOF

gmx grompp -f ../md.mdp -c ../md_config_start.gro -t ../md_config_start.cpt -p ../topol.top -o ${output_file}.tpr -maxwarn 1
mpirun gmx_mpi mdrun -deffnm ${output_file} -plumed plumed.dat
i=$((${i}+1))
done
